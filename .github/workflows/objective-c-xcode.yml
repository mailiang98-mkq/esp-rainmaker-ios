name: Xcode - Build and Analyze

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    name: Build and analyse default scheme using xcodebuild command
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Locate Xcode project/workspace
        run: |
          # 查找项目/工作区（支持子目录）
          proj_files=$(find . -maxdepth 3 -type d -name "*.xcodeproj" | head -n 1)
          workspace_files=$(find . -maxdepth 3 -type d -name "*.xcworkspace" | head -n 1)
          
          if [ -n "$workspace_files" ]; then
            echo "FILETYPE_PARAMETER=workspace" >> $GITHUB_ENV
            echo "FILE_TO_BUILD=$workspace_files" >> $GITHUB_ENV
            echo "Found workspace: $workspace_files"
          elif [ -n "$proj_files" ]; then
            echo "FILETYPE_PARAMETER=project" >> $GITHUB_ENV
            echo "FILE_TO_BUILD=$proj_files" >> $GITHUB_ENV
            echo "Found project: $proj_files"
          else
            echo "Error: No Xcode project or workspace found"
            exit 1
          fi

      - name: Get default scheme (兼容项目和工作区)
        run: |
          # 获取JSON结构并兼容不同格式
          scheme_json=$(xcodebuild -list -json -${{ env.FILETYPE_PARAMETER }} "${{ env.FILE_TO_BUILD }}")
          echo "Raw JSON: $scheme_json"  # 调试用，可删除
          
          # 尝试从project或workspace节点获取targets
          default_scheme=$(echo "$scheme_json" | ruby -e '
            require "json"
            data = JSON.parse(STDIN.gets)
            targets = data["project"] && data["project"]["targets"] || data["workspace"] && data["workspace"]["targets"]
            puts targets ? targets.first : nil
          ')
          
          if [ -z "$default_scheme" ]; then
            echo "Error: No default scheme found in targets"
            exit 1
          fi
          
          echo "DEFAULT_SCHEME=$default_scheme" >> $GITHUB_ENV
          echo "Using default scheme: $default_scheme"

      - name: Build
        run: |
          xcodebuild clean build analyze \
            -scheme "${{ env.DEFAULT_SCHEME }}" \
            -${{ env.FILETYPE_PARAMETER }} "${{ env.FILE_TO_BUILD }}" \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ~/Library/Logs/Xcode/
