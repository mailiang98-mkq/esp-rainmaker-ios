name: Xcode - Build and Analyze

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    name: Build and analyse default scheme using xcodebuild command
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Locate Xcode project/workspace
        run: |
          # 查找所有 .xcodeproj 和 .xcworkspace 文件（包括子目录）
          proj_files=$(find . -maxdepth 3 -type d -name "*.xcodeproj" | head -n 1)
          workspace_files=$(find . -maxdepth 3 -type d -name "*.xcworkspace" | head -n 1)
          
          # 优先使用工作区，如果没有则使用项目
          if [ -n "$workspace_files" ]; then
            echo "FILETYPE_PARAMETER=workspace" >> $GITHUB_ENV
            echo "FILE_TO_BUILD=$workspace_files" >> $GITHUB_ENV
            echo "Found workspace: $workspace_files"
          elif [ -n "$proj_files" ]; then
            echo "FILETYPE_PARAMETER=project" >> $GITHUB_ENV
            echo "FILE_TO_BUILD=$proj_files" >> $GITHUB_ENV
            echo "Found project: $proj_files"
          else
            echo "Error: No Xcode project or workspace found"
            exit 1
          fi

      - name: Get default scheme from project/workspace
        run: |
          # 从找到的项目/工作区中获取 scheme 列表
          scheme_list=$(xcodebuild -list -json -${{ env.FILETYPE_PARAMETER }} "${{ env.FILE_TO_BUILD }}" | tr -d "\n")
          default_scheme=$(echo "$scheme_list" | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
          
          if [ -z "$default_scheme" ]; then
            echo "Error: No default scheme found"
            exit 1
          fi
          
          echo "DEFAULT_SCHEME=$default_scheme" >> $GITHUB_ENV
          echo "Using default scheme: $default_scheme"

      - name: Build
        run: |
          xcodebuild clean build analyze \
            -scheme "${{ env.DEFAULT_SCHEME }}" \
            -${{ env.FILETYPE_PARAMETER }} "${{ env.FILE_TO_BUILD }}" \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ~/Library/Logs/Xcode/
