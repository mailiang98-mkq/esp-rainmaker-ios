name: Xcode - Build and Analyze

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    name: Build and analyse default scheme using xcodebuild command
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Locate Xcode project/workspace
        run: |
          # 查找项目/工作区（支持子目录）
          proj_files=$(find . -maxdepth 3 -type d -name "*.xcodeproj" | head -n 1)
          workspace_files=$(find . -maxdepth 3 -type d -name "*.xcworkspace" | head -n 1)
          
          if [ -n "$workspace_files" ]; then
            echo "FILETYPE_PARAMETER=workspace" >> $GITHUB_ENV
            echo "FILE_TO_BUILD=$workspace_files" >> $GITHUB_ENV
            echo "Found workspace: $workspace_files"
          elif [ -n "$proj_files" ]; then
            echo "FILETYPE_PARAMETER=project" >> $GITHUB_ENV
            echo "FILE_TO_BUILD=$proj_files" >> $GITHUB_ENV
            echo "Found project: $proj_files"
          else
            echo "Error: No Xcode project or workspace found"
            exit 1
          fi

      - name: Get default scheme (修复JSON解析和结构问题)
        run: |
          # 获取JSON并去除换行符（关键修复：避免解析时的格式错误）
          scheme_json=$(xcodebuild -list -json -${{ env.FILETYPE_PARAMETER }} "${{ env.FILE_TO_BUILD }}" | tr -d '\n')
          
          # 解析JSON，优先从schemes获取（你的工作区返回的是schemes数组）
          default_scheme=$(echo "$scheme_json" | ruby -e '
            require "json"
            begin
              data = JSON.parse(STDIN.gets)
              # 同时兼容workspace的schemes和project的targets/schemes
              schemes = data["workspace"] && data["workspace"]["schemes"] || 
                        data["project"] && (data["project"]["schemes"] || data["project"]["targets"])
              puts schemes ? schemes.first : nil
            rescue JSON::ParserError => e
              puts "JSON解析错误: #{e.message}"
              exit 1
            end
          ')
          
          if [ -z "$default_scheme" ]; then
            echo "Error: 未找到可用的scheme"
            exit 1
          fi
          
          echo "DEFAULT_SCHEME=$default_scheme" >> $GITHUB_ENV
          echo "使用默认scheme: $default_scheme"

      - name: Build
        run: |
          xcodebuild clean build analyze \
            -scheme "${{ env.DEFAULT_SCHEME }}" \
            -${{ env.FILETYPE_PARAMETER }} "${{ env.FILE_TO_BUILD }}" \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ~/Library/Logs/Xcode/
