name: ESP RainMaker iOS Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Locate Xcode project/workspace in subdirectory
        run: |
          # 查找子目录中的项目文件（优先工作区，支持最多2层子目录）
          WORKSPACE=$(find . -maxdepth 2 -type d -name "*.xcworkspace" | head -n 1)
          PROJECT=$(find . -maxdepth 2 -type d -name "*.xcodeproj" | head -n 1)
          
          # 确定实际存在的项目文件
          if [ -n "$WORKSPACE" ]; then
            echo "FILE_PATH=$WORKSPACE" >> $GITHUB_ENV
            echo "FILE_TYPE=workspace" >> $GITHUB_ENV
            echo "Found workspace: $WORKSPACE"
          elif [ -n "$PROJECT" ]; then
            echo "FILE_PATH=$PROJECT" >> $GITHUB_ENV
            echo "FILE_TYPE=project" >> $GITHUB_ENV
            echo "Found project: $PROJECT"
          else
            echo "Error: No Xcode project/workspace found in subdirectories"
            exit 1
          fi

      - name: Get default scheme from project
        run: |
          # 从找到的项目文件中提取scheme列表
          SCHEME_JSON=$(xcodebuild -list -json -${{ env.FILE_TYPE }} "${{ env.FILE_PATH }}" | tr -d '\n')
          DEFAULT_SCHEME=$(echo "$SCHEME_JSON" | ruby -e '
            require "json"
            begin
              data = JSON.parse(STDIN.gets)
              # 兼容workspace的schemes和project的targets
              schemes = data["workspace"] && data["workspace"]["schemes"] || 
                        data["project"] && (data["project"]["schemes"] || data["project"]["targets"])
              puts schemes ? schemes.first : nil
            rescue
              puts "Error parsing scheme JSON"
              exit 1
            end
          ')
          
          if [ -z "$DEFAULT_SCHEME" ]; then
            echo "Error: No valid scheme found"
            exit 1
          fi
          echo "DEFAULT_SCHEME=$DEFAULT_SCHEME" >> $GITHUB_ENV

      - name: Build with Xcode
        run: |
          xcodebuild clean build \
            -scheme "${{ env.DEFAULT_SCHEME }}" \
            -${{ env.FILE_TYPE }} "${{ env.FILE_PATH }}" \
            -destination "platform=iOS Simulator,name=iPhone 16" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
